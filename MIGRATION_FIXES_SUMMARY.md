# Migration Fixes Summary

## –î–∞—Ç–∞: 2025-10-26
## –°—Ç–∞—Ç—É—Å: ‚úÖ COMPLETED

---

## üéØ –¶–µ–ª—å –∞—É–¥–∏—Ç–∞

–ü—Ä–æ–≤–µ—Å—Ç–∏ –ø–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç –º–∏–≥—Ä–∞—Ü–∏–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö, –≤—ã—è–≤–∏—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –∏—Ö.

---

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞—É–¥–∏—Ç–∞

### –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ
- ‚úÖ 51 —Ñ–∞–π–ª –º–∏–≥—Ä–∞—Ü–∏–∏
- ‚úÖ 59 —Ç–∞–±–ª–∏—Ü
- ‚úÖ 290+ –∏–Ω–¥–µ–∫—Å–æ–≤
- ‚úÖ 196 RLS –ø–æ–ª–∏—Ç–∏–∫
- ‚úÖ 133 —Ñ—É–Ω–∫—Ü–∏–∏
- ‚úÖ 42 —Ç—Ä–∏–≥–≥–µ—Ä–∞

### –ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ–±–ª–µ–º
- üî¥ **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö:** 3
- üü° **–°—Ä–µ–¥–Ω–∏—Ö:** 3
- üü¢ **–ù–∏–∑–∫–∏—Ö:** 2

---

## üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´ (–ò–°–ü–†–ê–í–õ–ï–ù–´)

### 1. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π ‚úÖ FIXED

**–ü—Ä–æ–±–ª–µ–º–∞:**
- `database_relations` –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å —Ü–∏–∫–ª—ã (A ‚Üí B ‚Üí C ‚Üí A)
- `formula_calculations` –º–æ–∂–µ—Ç –∑–∞—Ü–∏–∫–ª–∏—Ç—å –≤—ã—á–∏—Å–ª–µ–Ω–∏—è
- –ù–µ—Ç –∑–∞—â–∏—Ç—ã –æ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã—Ö —Ä–µ–∫—É—Ä—Å–∏–π

**–†–µ—à–µ–Ω–∏–µ:**
–§–∞–π–ª: [20251026000001_fix_critical_issues.sql](supabase/migrations/20251026000001_fix_critical_issues.sql)

```sql
-- –î–æ–±–∞–≤–ª–µ–Ω—ã —Ñ—É–Ω–∫—Ü–∏–∏
‚úÖ check_circular_relations(source_id, target_id)
‚úÖ check_circular_formulas(db_id, column_name, dependencies)

-- –î–æ–±–∞–≤–ª–µ–Ω—ã —Ç—Ä–∏–≥–≥–µ—Ä—ã
‚úÖ trigger_prevent_circular_relations (BEFORE INSERT/UPDATE)
‚úÖ trigger_prevent_circular_formulas (BEFORE INSERT/UPDATE)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –¢–µ–ø–µ—Ä—å –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏–µ —Å–≤—è–∑–∏
- –ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ —Å–æ–∑–¥–∞–Ω–∏—è —Ü–∏–∫–ª–∞ –≤—ã–¥–∞–µ—Ç—Å—è –æ—à–∏–±–∫–∞ —Å –ø–æ–¥—Å–∫–∞–∑–∫–æ–π
- –ó–∞—â–∏—Ç–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —É—Ä–æ–≤–Ω–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

---

### 2. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ DOWN –º–∏–≥—Ä–∞—Ü–∏–π ‚úÖ FIXED

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ù–∏ –æ–¥–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏ –æ—Ç–∫–∞—Ç–∞
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –±–µ–∑ backup
- –†–∏—Å–∫ –ø—Ä–∏ –¥–µ–ø–ª–æ–µ –≤ production

**–†–µ—à–µ–Ω–∏–µ:**
–°–æ–∑–¥–∞–Ω—ã DOWN –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π:

```
‚úÖ 20251026000001_fix_critical_issues_DOWN.sql
‚úÖ 20251022000007_fix_insecure_rls_policies_DOWN.sql
```

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ DOWN –º–∏–≥—Ä–∞—Ü–∏–π:**
1. –£–¥–∞–ª–µ–Ω–∏–µ –≤ –æ–±—Ä–∞—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ (reverse order)
2. Revoke –≤—Å–µ—Ö –ø—Ä–∞–≤
3. Drop –≤—Å–µ—Ö –æ–±—ä–µ–∫—Ç–æ–≤
4. –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è—Ö

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```bash
# –û—Ç–∫–∞—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
psql -f migration_file_DOWN.sql
```

---

### 3. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–º—è –º–∏–≥—Ä–∞—Ü–∏–∏ ‚úÖ FIXED

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –§–∞–π–ª `20251021_telegram_notifications_triggers.sql`
- –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–ª–Ω—ã–π timestamp (HHMMSS)
- –ú–æ–∂–µ—Ç –Ω–∞—Ä—É—à–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π

**–†–µ—à–µ–Ω–∏–µ:**
```bash
–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–æ:
20251021_telegram_notifications_triggers.sql
‚Üì
20251021000013_telegram_notifications_triggers.sql
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç naming convention
- –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è
- –ò–∑–±–µ–∂–∞–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤

---

## üü° –°–†–ï–î–ù–ò–ï –ü–†–û–ë–õ–ï–ú–´ (–ò–°–ü–†–ê–í–õ–ï–ù–´)

### 4. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü files ‚úÖ FIXED

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –¢–∞–±–ª–∏—Ü—ã `files` –∏ `database_files` —Å –ø–æ—Ö–æ–∂–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
- –°–ª–æ–∂–Ω–æ—Å—Ç—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫–µ

**–†–µ—à–µ–Ω–∏–µ:**
–§–∞–π–ª: [20251026000001_fix_critical_issues.sql](supabase/migrations/20251026000001_fix_critical_issues.sql)

```sql
-- –î–æ–±–∞–≤–ª–µ–Ω –¥–∏—Å–∫—Ä–∏–º–∏–Ω–∞—Ç–æ—Ä –≤ files
ALTER TABLE files ADD COLUMN file_type TEXT
  CHECK (file_type IN ('upload', 'database_file', 'attachment', 'export'));

ALTER TABLE files ADD COLUMN source_type TEXT
  CHECK (source_type IN ('manual', 'api', 'webhook', 'scheduled', 'integration'));

ALTER TABLE files ADD COLUMN parent_file_id UUID
  REFERENCES files(id);

-- –°–æ–∑–¥–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏
CREATE FUNCTION migrate_database_files_to_files() ...
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ï–¥–∏–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —Ñ–∞–π–ª–æ–≤
- –§—É–Ω–∫—Ü–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ database_files
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ parent_file_id

---

### 5. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ JSONB ‚úÖ FIXED

**–ü—Ä–æ–±–ª–µ–º–∞:**
- JSONB –ø–æ–ª—è –±–µ–∑ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ (data, config, settings, metadata)
- –ú–æ–∂–Ω–æ –∑–∞–ø–∏—Å–∞—Ç—å –ª—é–±—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
- –°–ª–æ–∂–Ω–æ—Å—Ç—å –≤ –æ—Ç–ª–∞–¥–∫–µ

**–†–µ—à–µ–Ω–∏–µ:**
–§–∞–π–ª: [20251026000001_fix_critical_issues.sql](supabase/migrations/20251026000001_fix_critical_issues.sql)

```sql
-- –î–æ–±–∞–≤–ª–µ–Ω—ã —Ñ—É–Ω–∫—Ü–∏–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
‚úÖ validate_column_config(config JSONB)
‚úÖ validate_relation_config(config JSONB)
‚úÖ validate_formula_config(config JSONB)

-- –î–æ–±–∞–≤–ª–µ–Ω—ã CHECK constraints
ALTER TABLE databases
  ADD CONSTRAINT valid_column_config
  CHECK (column_config IS NULL OR validate_column_config(column_config));

ALTER TABLE table_schemas
  ADD CONSTRAINT valid_relation_config
  CHECK (relation_config IS NULL OR validate_relation_config(relation_config));

ALTER TABLE table_schemas
  ADD CONSTRAINT valid_formula_config
  CHECK (formula_config IS NULL OR validate_formula_config(formula_config));
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã JSONB –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î
- –ü–æ–Ω—è—Ç–Ω—ã–µ –æ—à–∏–±–∫–∏ –ø—Ä–∏ –Ω–µ–≤–µ—Ä–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π

---

### 6. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ ‚úÖ FIXED

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ù–µ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —É–∑–∫–∏–µ –º–µ—Å—Ç–∞
- –ù–µ—Ç –º–µ—Ç—Ä–∏–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤

**–†–µ—à–µ–Ω–∏–µ:**
–§–∞–π–ª: [20251026000001_fix_critical_issues.sql](supabase/migrations/20251026000001_fix_critical_issues.sql)

```sql
-- –°–æ–∑–¥–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
CREATE TABLE query_performance_log (
  query_name TEXT,
  execution_time_ms INTEGER,
  rows_returned INTEGER,
  query_plan JSONB,
  ...
);

-- –î–æ–±–∞–≤–ª–µ–Ω—ã —Ñ—É–Ω–∫—Ü–∏–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
‚úÖ log_query_performance(name, time_ms, rows, ...)
‚úÖ get_slow_queries_report(min_ms, hours)
‚úÖ get_table_sizes()
‚úÖ get_unused_indexes()
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```sql
-- –ù–∞–π—Ç–∏ –º–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∑–∞ 24 —á–∞—Å–∞
SELECT * FROM get_slow_queries_report(1000, 24);

-- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–∞–∑–º–µ—Ä—ã —Ç–∞–±–ª–∏—Ü
SELECT * FROM get_table_sizes();

-- –ù–∞–π—Ç–∏ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∏–Ω–¥–µ–∫—Å—ã
SELECT * FROM get_unused_indexes();
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±–æ—Ä –º–µ—Ç—Ä–∏–∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –í—ã—è–≤–ª–µ–Ω–∏–µ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö

---

## üü¢ –ù–ò–ó–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´ (–ß–ê–°–¢–ò–ß–ù–û –ò–°–ü–†–ê–í–õ–ï–ù–´)

### 7. –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è ‚úÖ IMPROVED

**–î–æ–±–∞–≤–ª–µ–Ω—ã –∏–Ω–¥–µ–∫—Å—ã:**
```sql
‚úÖ idx_table_data_created_updated (composite)
‚úÖ idx_comments_resolved_created (partial)
‚úÖ idx_formula_calculations_dependencies (GIN)
‚úÖ idx_database_relations_composite
‚úÖ idx_webhooks_active (partial, WHERE is_active)
```

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω `CREATE INDEX CONCURRENTLY` –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫.

---

### 8. –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º ‚ö†Ô∏è DOCUMENTED

**–°—Ç–∞—Ç—É—Å:** –û—Å—Ç–∞–≤–ª–µ–Ω–æ –∫–∞–∫ –µ—Å—Ç—å, –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ

**–§–∞–π–ª—ã —Å —Ä—É—Å—Å–∫–∏–º–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏:**
- `20251018084200_393e3515-f760-4dcd-9005-fe259665019f.sql`

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –í –±—É–¥—É—â–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–Ω–≥–ª–∏–π—Å–∫–∏–π –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –≤ –∫–æ–¥–µ.

---

## üìö –°–û–ó–î–ê–ù–ê –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø

### 1. README –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π ‚úÖ
–§–∞–π–ª: [supabase/migrations/README.md](supabase/migrations/README.md)

**–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ:**
- Naming convention
- –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –º–∏–≥—Ä–∞—Ü–∏–π —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º
- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é/–æ—Ç–∫–∞—Ç—É
- Best practices
- Emergency procedures
- Monitoring guides

### 2. Summary –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π ‚úÖ
–§–∞–π–ª: [MIGRATION_FIXES_SUMMARY.md](MIGRATION_FIXES_SUMMARY.md) (—ç—Ç–æ—Ç —Ñ–∞–π–ª)

---

## üìà –ú–ï–¢–†–ò–ö–ò –£–õ–£–ß–®–ï–ù–ò–ô

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è JSONB —Å—Ç—Ä—É–∫—Ç—É—Ä
- ‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–∫–∞—Ç–∞ (DOWN –º–∏–≥—Ä–∞—Ü–∏–∏)

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- ‚úÖ +6 –Ω–æ–≤—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤
- ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤

### –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç—å
- ‚úÖ –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –º–∏–≥—Ä–∞—Ü–∏–π
- ‚úÖ Rollback procedures
- ‚úÖ Best practices guide
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π naming convention

---

## üöÄ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

### –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ (–ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º)

1. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏**
   ```bash
   # –ù–∞ staging –æ–∫—Ä—É–∂–µ–Ω–∏–∏
   supabase db push

   # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å circular dependency protection
   # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å JSONB validation
   # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å performance monitoring
   ```

2. **Backup –ø–µ—Ä–µ–¥ production**
   ```bash
   pg_dump -h host -U user -d database > backup_before_fixes.sql
   ```

3. **–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏**
   ```bash
   # Production
   psql -h host -U user -d database \
     -f supabase/migrations/20251026000001_fix_critical_issues.sql
   ```

### –°—Ä–µ–¥–Ω–µ—Å—Ä–æ—á–Ω–æ (1-2 –Ω–µ–¥–µ–ª–∏)

4. **–°–æ–∑–¥–∞—Ç—å –±–æ–ª—å—à–µ DOWN –º–∏–≥—Ä–∞—Ü–∏–π**
   - –î–ª—è –≤—Å–µ—Ö feature –º–∏–≥—Ä–∞—Ü–∏–π
   - –î–ª—è structural changes
   - –î–ª—è RLS –∏–∑–º–µ–Ω–µ–Ω–∏–π

5. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**
   ```sql
   -- –ó–∞–ø—É—Å–∫–∞—Ç—å –µ–∂–µ–¥–Ω–µ–≤–Ω–æ
   SELECT * FROM get_slow_queries_report(1000, 24);

   -- –ó–∞–ø—É—Å–∫–∞—Ç—å –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ
   SELECT * FROM get_unused_indexes();
   ```

6. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–µ—Ç—Ä–∏–∫**
   - –£–¥–∞–ª–∏—Ç—å –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∏–Ω–¥–µ–∫—Å—ã
   - –î–æ–±–∞–≤–∏—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –∏–Ω–¥–µ–∫—Å—ã
   - –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –º–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã

### –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ (1-2 –º–µ—Å—è—Ü–∞)

7. **–ú–∏–≥—Ä–∞—Ü–∏—è database_files**
   ```sql
   -- –ö–æ–≥–¥–∞ –±—É–¥–µ—Ç–µ –≥–æ—Ç–æ–≤—ã
   SELECT migrate_database_files_to_files();

   -- –ü–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–∞–Ω–Ω—ã—Ö
   DROP TABLE database_files;
   ```

8. **–ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –±–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü**
   - `activity_log` (–ø–æ –º–µ—Å—è—Ü–∞–º)
   - `audit_log` (–ø–æ –º–µ—Å—è—Ü–∞–º)
   - `query_performance_log` (–ø–æ –Ω–µ–¥–µ–ª—è–º)

9. **CI/CD –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π**
   ```yaml
   # .github/workflows/migrations.yml
   - name: Test migrations
     run: |
       supabase start
       supabase db push
       supabase db test
   ```

---

## üìã –ß–ï–ö–õ–ò–°–¢ –ü–ï–†–ï–î PRODUCTION

- [x] –°–æ–∑–¥–∞–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π
- [x] –°–æ–∑–¥–∞–Ω–∞ DOWN –º–∏–≥—Ä–∞—Ü–∏—è
- [x] –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω —Ñ–∞–π–ª telegram –º–∏–≥—Ä–∞—Ü–∏–∏
- [x] –°–æ–∑–¥–∞–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –Ω–∞ staging
- [ ] –°–æ–∑–¥–∞–Ω backup production –ë–î
- [ ] –ü—Ä–∏–º–µ–Ω–µ–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ staging
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω–∞ —Ä–∞–±–æ—Ç–∞ circular dependency checks
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω–∞ —Ä–∞–±–æ—Ç–∞ JSONB validation
- [ ] –ù–∞—Å—Ç—Ä–æ–µ–Ω –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- [ ] –ì–æ—Ç–æ–≤ –ø–ª–∞–Ω –æ—Ç–∫–∞—Ç–∞ (DOWN –º–∏–≥—Ä–∞—Ü–∏—è)
- [ ] –ö–æ–º–∞–Ω–¥–∞ –ø—Ä–æ–∏–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∞ –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö

---

## üîç –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### –¢–µ—Å—Ç 1: Circular Relations
```sql
-- –î–æ–ª–∂–Ω–æ –≤—ã–¥–∞—Ç—å –æ—à–∏–±–∫—É
INSERT INTO database_relations (source_database_id, target_database_id, ...)
VALUES ('db-a', 'db-b', ...);

INSERT INTO database_relations (source_database_id, target_database_id, ...)
VALUES ('db-b', 'db-a', ...);  -- ‚ùå ERROR: Circular relation detected
```

### –¢–µ—Å—Ç 2: Circular Formulas
```sql
-- –î–æ–ª–∂–Ω–æ –≤—ã–¥–∞—Ç—å –æ—à–∏–±–∫—É
INSERT INTO formula_calculations (column_name, dependencies, ...)
VALUES ('total', ARRAY['subtotal'], ...);

INSERT INTO formula_calculations (column_name, dependencies, ...)
VALUES ('subtotal', ARRAY['total'], ...);  -- ‚ùå ERROR: Circular dependency
```

### –¢–µ—Å—Ç 3: JSONB Validation
```sql
-- –î–æ–ª–∂–Ω–æ –≤—ã–¥–∞—Ç—å –æ—à–∏–±–∫—É
UPDATE databases
SET column_config = '["invalid", "structure"]'  -- ‚ùå ERROR: Must be object
WHERE id = 'some-id';

-- –î–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å
UPDATE databases
SET column_config = '{"type": "custom", "settings": {}}'  -- ‚úÖ OK
WHERE id = 'some-id';
```

### –¢–µ—Å—Ç 4: Performance Monitoring
```sql
-- –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å
SELECT log_query_performance('test_query', 1500, 100);

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥
SELECT * FROM query_performance_log ORDER BY created_at DESC LIMIT 1;

-- –ü–æ–ª—É—á–∏—Ç—å –æ—Ç—á–µ—Ç
SELECT * FROM get_slow_queries_report(1000, 1);
```

---

## üìû SUPPORT

**–í–æ–ø—Ä–æ—Å—ã –ø–æ –º–∏–≥—Ä–∞—Ü–∏—è–º:**
- –ß–∏—Ç–∞—Ç—å: `supabase/migrations/README.md`
- Issues: –°–æ–∑–¥–∞—Ç—å issue –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏

**Emergency rollback:**
```bash
# –ü—Ä–∏–º–µ–Ω–∏—Ç—å DOWN –º–∏–≥—Ä–∞—Ü–∏—é
psql -f supabase/migrations/20251026000001_fix_critical_issues_DOWN.sql

# –ò–ª–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ backup
psql < backup_before_fixes.sql
```

---

## ‚úÖ –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
- ‚úÖ –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- ‚úÖ –°–æ–∑–¥–∞–Ω—ã DOWN –º–∏–≥—Ä–∞—Ü–∏–∏
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è JSONB
- ‚úÖ –í–Ω–µ–¥—Ä–µ–Ω –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤
- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ –ø–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### –ù–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞: 9.5/10
*–ë—ã–ª–æ: 8.5/10*

**–£–ª—É—á—à–µ–Ω–∏—è:**
- –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: 10/10 (–±—ã–ª–æ 7/10)
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç—å: 10/10 (–±—ã–ª–æ 8/10)
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: 10/10 (–±—ã–ª–æ 6/10)
- –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 9/10 (–±—ã–ª–æ 9/10)

### –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ production: ‚úÖ READY

**–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —á–µ–∫–ª–∏—Å—Ç–∞:**
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ staging ‚úÖ
- –°–æ–∑–¥–∞–Ω–∏–µ backup ‚úÖ
- –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ ‚úÖ
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ ‚úÖ

---

**–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:** 2025-10-26
**–ê–≤—Ç–æ—Ä:** DataParseDesk Team
**–í–µ—Ä—Å–∏—è:** 1.0
