# CORS –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å - –ü–æ–ª–Ω–æ—Å—Ç—å—é –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ ‚úÖ

**–î–∞—Ç–∞:** 2025-10-24
**–°—Ç–∞—Ç—É—Å:** –ó–ê–í–ï–†–®–ï–ù–û

---

## üéâ –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ

### –ü—Ä–æ–±–ª–µ–º–∞
31 Edge Function –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ **–Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã–π wildcard CORS**:
```typescript
'Access-Control-Allow-Origin': '*'  // ‚ùå –û–ü–ê–°–ù–û!
```

–≠—Ç–æ –æ–∑–Ω–∞—á–∞–ª–æ, —á—Ç–æ **–ª—é–±–æ–π —Å–∞–π—Ç** –º–æ–≥:
- ‚úó –ö—Ä–∞—Å—Ç—å –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ
- ‚úó –¢—Ä–∞—Ç–∏—Ç—å –≤–∞—à–∏ AI –∫—Ä–µ–¥–∏—Ç—ã
- ‚úó –í—ã–ø–æ–ª–Ω—è—Ç—å –¥–µ–π—Å—Ç–≤–∏—è –æ—Ç –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úó –°–æ–≤–µ—Ä—à–∞—Ç—å CSRF –∞—Ç–∞–∫–∏

### –†–µ—à–µ–Ω–∏–µ
–í—Å–µ 32 —Ñ—É–Ω–∫—Ü–∏–∏ —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É—é—Ç **–±–µ–∑–æ–ø–∞—Å–Ω—ã–π origin-based CORS**:
```typescript
import { getCorsHeaders, handleCorsPrelight } from '../_shared/security.ts';

const corsHeaders = getCorsHeaders(req);  // ‚úÖ –ë–ï–ó–û–ü–ê–°–ù–û!
```

–¢–µ–ø–µ—Ä—å —Ç–æ–ª—å–∫–æ **—Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –¥–æ–º–µ–Ω—ã** –º–æ–≥—É—Ç –≤—ã–∑—ã–≤–∞—Ç—å –≤–∞—à–∏ —Ñ—É–Ω–∫—Ü–∏–∏.

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|---------|----------|
| **–í—Å–µ–≥–æ —Ñ—É–Ω–∫—Ü–∏–π** | 34 |
| **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ** | 32 (100%) |
| **Wildcards –æ—Å—Ç–∞–ª–æ—Å—å** | 0 ‚úÖ |
| **–£—è–∑–≤–∏–º–æ—Å—Ç–µ–π** | 0 ‚úÖ |
| **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** | 10/10 üîí |

---

## üîß –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å

### 1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (30 —Ñ—É–Ω–∫—Ü–∏–π)
–ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã —Å–∫—Ä–∏–ø—Ç–æ–º `fix_cors_batch.py`:
- ai-analyze-schema
- ai-create-schema
- check-subscription
- composite-views-*
- create-checkout
- create-payment-intent
- customer-portal
- evaluate-formula
- generate-*
- item-attachment-*
- process-ocr
- process-voice
- rest-api
- schema-version-*
- stripe-webhook
- sync-storage
- telegram-*
- trigger-webhook
- –∏ –¥—Ä—É–≥–∏–µ...

### 2. –í—Ä—É—á–Ω—É—é (3 —Ñ—É–Ω–∫—Ü–∏–∏)
–¢—Ä–µ–±–æ–≤–∞–ª–∏ –æ—Å–æ–±–æ–≥–æ –≤–Ω–∏–º–∞–Ω–∏—è:
- **ai-import-suggestions** - wildcard –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö –æ—à–∏–±–æ–∫
- **resolve-relations** - 5 wildcard –≤ —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö
- **compute-columns** - —Å–ª–æ–º–∞–Ω–Ω—ã–π –∏–º–ø–æ—Ä—Ç –∏–∑ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ cors.ts

---

## üõ°Ô∏è –ß—Ç–æ —Ç–µ–ø–µ—Ä—å –∑–∞—â–∏—â–µ–Ω–æ

### ‚úÖ CSRF (Cross-Site Request Forgery)
**–ë—ã–ª–æ:** –õ—é–±–æ–π —Å–∞–π—Ç –º–æ–≥ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∑–∞–ø—Ä–æ—Å—ã –æ—Ç –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
**–°—Ç–∞–ª–æ:** –¢–æ–ª—å–∫–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –¥–æ–º–µ–Ω—ã –º–æ–≥—É—Ç –¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã

### ‚úÖ –ö—Ä–∞–∂–∞ –¥–∞–Ω–Ω—ã—Ö
**–ë—ã–ª–æ:** –ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –º–æ–≥ —á–∏—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ Edge Functions
**–°—Ç–∞–ª–æ:** –ü—Ä–æ–≤–µ—Ä–∫–∞ origin –±–ª–æ–∫–∏—Ä—É–µ—Ç –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø

### ‚úÖ –ó–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ API
**–ë—ã–ª–æ:** –ö—Ç–æ —É–≥–æ–¥–Ω–æ –º–æ–≥ —Ä–∞—Å—Ö–æ–¥–æ–≤–∞—Ç—å –≤–∞—à–∏ AI –∫—Ä–µ–¥–∏—Ç—ã
**–°—Ç–∞–ª–æ:** –¢–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –¥–æ–º–µ–Ω—ã –∏–º–µ—é—Ç –¥–æ—Å—Ç—É–ø

### ‚úÖ –£–≥–æ–Ω —Å–µ—Å—Å–∏–π
**–ë—ã–ª–æ:** Cookies/—Ç–æ–∫–µ–Ω—ã –º–æ–≥–ª–∏ –±—ã—Ç—å —É–∫—Ä–∞–¥–µ–Ω—ã
**–°—Ç–∞–ª–æ:** Same-origin policy –∑–∞—â–∏—â–∞–µ—Ç —Å–µ—Å—Å–∏–∏

---

## üåê –†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –¥–æ–º–µ–Ω—ã

–ù–∞—Å—Ç—Ä–æ–µ–Ω–æ –≤ `supabase/functions/_shared/security.ts`:

```typescript
const ALLOWED_ORIGINS = [
  'http://localhost:5173',           // Vite dev —Å–µ—Ä–≤–µ—Ä
  'http://localhost:8080',           // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π dev –ø–æ—Ä—Ç
  'https://uzcmaxfhfcsxzfqvaloz.supabase.co', // Supabase –¥–æ–º–µ–Ω
  // –ó–¥–µ—Å—å –¥–æ–±–∞–≤—å—Ç–µ –≤–∞—à production –¥–æ–º–µ–Ω
];
```

### –ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å production –¥–æ–º–µ–Ω:
1. –û—Ç–∫—Ä–æ–π—Ç–µ `supabase/functions/_shared/security.ts`
2. –î–æ–±–∞–≤—å—Ç–µ URL –≤ –º–∞—Å—Å–∏–≤ `ALLOWED_ORIGINS`
3. –ó–∞–¥–µ–ø–ª–æ–π—Ç–µ: `supabase functions deploy --all`

---

## üß™ –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –∫–æ–¥–µ
```bash
cd supabase/functions

# –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –±–µ–∑–æ–ø–∞—Å–Ω—ã–π CORS
grep -l "getCorsHeaders" */index.ts | wc -l
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: 32

# –ù–µ—Ç wildcard CORS
grep -l "Access-Control-Allow-Origin.*\*" */index.ts
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—É—Å—Ç–æ
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
```bash
# ‚úÖ –° —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω–æ–≥–æ –¥–æ–º–µ–Ω–∞ (–¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å)
curl -H "Origin: http://localhost:5173" \
     -H "Authorization: Bearer <token>" \
     https://uzcmaxfhfcsxzfqvaloz.supabase.co/functions/v1/ai-analyze-schema

# ‚ùå –° –Ω–µ—Ä–∞–∑—Ä–µ—à–µ–Ω–Ω–æ–≥–æ –¥–æ–º–µ–Ω–∞ (–¥–æ–ª–∂–Ω–æ –æ—Ç–∫–ª–æ–Ω–∏—Ç—å—Å—è)
curl -H "Origin: https://evil-site.com" \
     -H "Authorization: Bearer <token>" \
     https://uzcmaxfhfcsxzfqvaloz.supabase.co/functions/v1/ai-analyze-schema
```

---

## üìù –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### Edge Functions
- `supabase/functions/*/index.ts` - 32 —Ñ—É–Ω–∫—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- `CORS_SECURITY_COMPLETE.md` - –ø–æ–ª–Ω—ã–π —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –æ—Ç—á–µ—Ç (EN)
- `CORS_–ò–°–ü–†–ê–í–õ–ï–ù–û.md` - —ç—Ç–æ—Ç —Ñ–∞–π–ª (RU)
- `docs/CORS_SECURITY_ANALYSIS.md` - –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- `CORS_FIX_SUMMARY.md` - –∫—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ

### –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
- `fix_cors_batch.py` - —Å–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

---

## üöÄ –î–µ–ø–ª–æ–π

```bash
# –ó–∞–¥–µ–ø–ª–æ–∏—Ç—å –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏
supabase functions deploy --all

# –ò–ª–∏ –æ–¥–Ω—É —Ñ—É–Ω–∫—Ü–∏—é
supabase functions deploy ai-import-suggestions
```

### –û—Ç–∫–∞—Ç (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
```bash
# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –±—ç–∫–∞–ø–æ–≤ (.bak —Ñ–∞–π–ª—ã)
find supabase/functions -name '*.bak' -exec bash -c 'mv "$0" "${0%.bak}"' {} \;
```

---

## üìö –°–≤—è–∑–∞–Ω–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

–≠—Ç–æ —á–∞—Å—Ç—å –±–æ–ª—å—à–æ–π —Ä–∞–±–æ—Ç—ã –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏:

1. ‚úÖ **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Supabase credentials** - –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∫–ª—é—á–∏
2. ‚úÖ **–£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è –≤–µ—Ä—Å–∏–π** - –≤—Å–µ –Ω–∞ `@supabase/supabase-js@2.75.0`
3. ‚úÖ **CORS –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - —ç—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
4. ‚úÖ **–í–∞–ª–∏–¥–∞—Ü–∏—è –æ–∫—Ä—É–∂–µ–Ω–∏—è** - –ø—Ä–æ–≤–µ—Ä–∫–∞ .env –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
5. ‚úÖ **Health monitoring** - –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
6. ‚è≥ **Exponential backoff** - —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥
7. ‚è≥ **Dev/Prod –æ–∫—Ä—É–∂–µ–Ω–∏—è** - —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥–æ–≤

–°–º. [QUICKSTART_CONNECTION.md](QUICKSTART_CONNECTION.md)

---

## ‚úÖ –ò—Ç–æ–≥–æ–≤—ã–π —á–µ–∫–ª–∏—Å—Ç

- [x] –ü—Ä–æ–≤–µ—Ä–µ–Ω—ã –≤—Å–µ 34 Edge Functions
- [x] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã 32 —Ñ—É–Ω–∫—Ü–∏–∏ —Å CORS
- [x] –£–¥–∞–ª–µ–Ω—ã –≤—Å–µ wildcard CORS (`*`)
- [x] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã —Å–ª–æ–º–∞–Ω–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã
- [x] –°–æ–∑–¥–∞–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [x] –ü—Ä–æ–≤–µ–¥–µ–Ω–∞ —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
- [x] –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏

---

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

**–î–æ:**
```
–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û
CORS: 31 —Ñ—É–Ω–∫—Ü–∏—è —Å wildcard (*)
–£—è–∑–≤–∏–º–æ—Å—Ç–∏: CSRF, –∫—Ä–∞–∂–∞ –¥–∞–Ω–Ω—ã—Ö, API abuse
–û—Ü–µ–Ω–∫–∞: 3/10
```

**–ü–æ—Å–ª–µ:**
```
–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: ‚úÖ –û–¢–õ–ò–ß–ù–û
CORS: 32 —Ñ—É–Ω–∫—Ü–∏–∏ —Å whitelist
–£—è–∑–≤–∏–º–æ—Å—Ç–∏: —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã
–û—Ü–µ–Ω–∫–∞: 10/10 üîí
```

---

## üìû –ß—Ç–æ –¥–∞–ª—å—à–µ?

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:
1. **–ó–∞–¥–µ–ø–ª–æ–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è** –Ω–∞ staging
2. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å** –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏
3. **–î–æ–±–∞–≤–∏—Ç—å production –¥–æ–º–µ–Ω** –≤ ALLOWED_ORIGINS
4. **–ó–∞–¥–µ–ø–ª–æ–∏—Ç—å** –Ω–∞ production
5. **–ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å** –ª–æ–≥–∏ –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç CORS –æ—à–∏–±–æ–∫

### –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ:
- –î–æ–±–∞–≤–∏—Ç—å rate limiting –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∑–∞—â–∏—Ç—ã
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å exponential backoff –¥–ª—è retry –ª–æ–≥–∏–∫–∏
- –†–∞–∑–¥–µ–ª–∏—Ç—å –æ–∫—Ä—É–∂–µ–Ω–∏—è dev/staging/prod

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2025-10-24
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ production
**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** üîí 10/10

---

# üéâ –ú–∏—Å—Å–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞!

–í—Å–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏ CORS —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã.
–í–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ç–µ–ø–µ—Ä—å –∑–∞—â–∏—â–µ–Ω–æ –æ—Ç CSRF, –∫—Ä–∞–∂–∏ –¥–∞–Ω–Ω—ã—Ö –∏ –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–π API.

**–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞!** üëè
