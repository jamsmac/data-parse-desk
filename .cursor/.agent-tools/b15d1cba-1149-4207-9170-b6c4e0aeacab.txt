
> vite_react_shadcn_ts@0.0.0 test:run
> vitest run


 RUN  v3.2.4 /workspace

 ✓ src/api/__tests__/databaseAPI.test.ts (24 tests) 9ms
 ❯ tests/unit/api/databaseAPI.test.ts (10 tests | 4 failed) 1701ms
   ✓ DatabaseAPI > getAllDatabases > should return all databases for user 2ms
   ✓ DatabaseAPI > getAllDatabases > should handle errors gracefully 1ms
   ✓ DatabaseAPI > createDatabase > should create a new database 1ms
   ✓ DatabaseAPI > createDatabase > should generate system_name from display_name 0ms
   × DatabaseAPI > updateDatabase > should update database properties 827ms
     → Could not find the function public.update_database(p_id, p_updates) in the schema cache
   × DatabaseAPI > deleteDatabase > should delete database and related data 229ms
     → Could not find the function public.delete_database(p_id) in the schema cache
   ✓ DatabaseAPI > getTableData > should fetch table data with pagination 1ms
   ✓ DatabaseAPI > getTableData > should handle filters correctly 1ms
   × DatabaseAPI > getTableSchema > should fetch table schema 632ms
     → Could not find the function public.get_table_schemas(p_database_id) in the schema cache
   × DatabaseAPI > updateTableSchema > should update table schema 4ms
     → supabase.from(...).select is not a function
 ❯ tests/unit/utils/formulaEngine.test.ts (23 tests | 15 failed) 24ms
   ✓ FormulaEngine > parseFormula > should parse simple mathematical expressions 2ms
   × FormulaEngine > parseFormula > should parse function calls 5ms
     → Invalid syntax: Error: Unexpected token: function SUM
   × FormulaEngine > parseFormula > should parse nested functions 0ms
     → Invalid syntax: Error: Unexpected token: function IF
   × FormulaEngine > parseFormula > should handle parentheses correctly 2ms
     → Invalid syntax: RangeError: Maximum call stack size exceeded
   × FormulaEngine > parseFormula > should throw error for invalid syntax 3ms
     → expected [Function] to throw an error
   × FormulaEngine > evaluateFormula > should evaluate simple mathematical expressions 2ms
     → expected 2 to be 8 // Object.is equality
   ✓ FormulaEngine > evaluateFormula > should evaluate column references 0ms
   ✓ FormulaEngine > evaluateFormula > should evaluate mathematical functions 0ms
   × FormulaEngine > evaluateFormula > should evaluate string functions 1ms
     → expected '5' to be 5 // Object.is equality
   ✓ FormulaEngine > evaluateFormula > should evaluate date functions 0ms
   ✓ FormulaEngine > evaluateFormula > should evaluate logical functions 0ms
   × FormulaEngine > evaluateFormula > should evaluate aggregation functions 0ms
     → expected '01,2,3,4,5' to be 15 // Object.is equality
   × FormulaEngine > evaluateFormula > should handle complex nested expressions 1ms
     → expected NaN to be 66 // Object.is equality
   × FormulaEngine > evaluateFormula > should throw error for invalid expressions 1ms
     → expected [Function] to throw an error
   × FormulaEngine > validateFormula > should validate correct formulas 1ms
     → expected { valid: true } to be true // Object.is equality
   × FormulaEngine > validateFormula > should reject invalid formulas 1ms
     → expected { valid: false, …(1) } to be false // Object.is equality
   × FormulaEngine > getAvailableFunctions > should return all available functions 1ms
     → expected [] to include 'SUM'
   ✓ FormulaEngine > getAvailableFunctions > should categorize functions correctly 0ms
   ✓ FormulaEngine > FormulaEngine class > should create formula with dependencies 0ms
   × FormulaEngine > FormulaEngine class > should evaluate formula with context 0ms
     → expected 110.00000000000001 to be 110 // Object.is equality
   ✓ FormulaEngine > FormulaEngine class > should track dependencies correctly 0ms
   × FormulaEngine > FormulaEngine class > should recalculate dependent formulas 0ms
     → expected NaN to be 210 // Object.is equality
   × FormulaEngine > FormulaEngine class > should handle circular dependencies 1ms
     → expected [Function] to throw an error
 ✓ src/components/aurora/__tests__/AuroraBackground.test.tsx (29 tests) 465ms
 ✓ src/components/ui/__tests__/button.test.tsx (4 tests) 134ms
 ✓ src/components/aurora/__tests__/Animations.test.tsx (35 tests) 110ms
 ✓ src/components/common/__tests__/LoadingSpinner.test.tsx (3 tests) 103ms
 ✓ src/components/aurora/__tests__/GlassCard.test.tsx (30 tests) 87ms
 ✓ src/utils/__tests__/parseData.test.ts (30 tests) 38ms
 ✓ src/api/__tests__/fileAPI.test.ts (26 tests) 21ms
stderr | src/utils/__tests__/formulaEngine.test.ts > FormulaEngine > calculateFormula > Обработка ошибок > должен возвращать ошибку при неизвестной функции
Ошибка вычисления формулы: Error: Unknown function: unknown_func
    at parsePrimary (/workspace/src/utils/formulaEngine.ts:421:15)
    at parseUnary (/workspace/src/utils/formulaEngine.ts:367:12)
    at parseMulDiv (/workspace/src/utils/formulaEngine.ts:340:16)
    at parseAddSub (/workspace/src/utils/formulaEngine.ts:317:16)
    at parseComparison (/workspace/src/utils/formulaEngine.ts:286:16)
    at parseEquality (/workspace/src/utils/formulaEngine.ts:268:16)
    at parseAnd (/workspace/src/utils/formulaEngine.ts:256:16)
    at parseOr (/workspace/src/utils/formulaEngine.ts:244:16)
    at parseExpression (/workspace/src/utils/formulaEngine.ts:240:12)
    at evaluate (/workspace/src/utils/formulaEngine.ts:465:10)

 ✓ src/utils/__tests__/formulaEngine.test.ts (37 tests) 16ms
 ✓ src/api/__tests__/relationAPI.test.ts (27 tests) 11ms
 ✓ tests/memory-leaks.test.tsx (11 tests) 10ms
 ✓ tests/regression/aurora-fixes.test.ts (15 tests) 5ms
 ✓ src/utils/__tests__/columnMapper.test.ts (8 tests) 4ms
 ❯ src/utils/__tests__/fileParser.test.ts (14 tests | 1 failed) 11782ms
   ✓ FileParser > parseFile > CSV файлы > должен парсить простой CSV файл 5ms
   ✓ FileParser > parseFile > CSV файлы > должен обрабатывать CSV с запятыми в кавычках 1ms
   ✓ FileParser > parseFile > CSV файлы > должен обрабатывать пустые значения в CSV 1ms
   ✓ FileParser > parseFile > CSV файлы > должен обрабатывать различные разделители строк 0ms
   ✓ FileParser > parseFile > CSV файлы > должен обрабатывать Unicode символы 0ms
   ✓ FileParser > parseFile > Excel файлы > должен отклонять файлы Excel (временно не поддерживается) 0ms
   ✓ FileParser > parseFile > Обработка ошибок > должен отклонять файлы неподдерживаемых форматов 1ms
   ✓ FileParser > parseFile > Обработка ошибок > должен отклонять пустые файлы 0ms
   × FileParser > parseFile > Обработка ошибок > должен проверять размер файлов 11751ms
     → Test timed out in 5000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".
   ✓ FileParser > parseFile > Нормализация данных > должен добавлять нормализованные поля даты 15ms
   ✓ FileParser > parseFile > Нормализация данных > должен добавлять нормализованные поля суммы 0ms
   ✓ FileParser > parseFile > Нормализация данных > должен генерировать уникальные ID для строк 0ms
   ✓ FileParser > parseFile > Производительность > должен обрабатывать большие файлы эффективно 5ms
   ✓ FileParser > parseFile > Совместимость с различными кодировками > должен корректно читать UTF-8 0ms
 ❯ tests/performance/performance.test.ts (13 tests | 7 failed) 368460ms
   × Performance Tests > File Parsing Performance > should parse 1MB file within 2 seconds 2735ms
     → expected 2613.545099 to be less than 2000
   × Performance Tests > File Parsing Performance > should parse 10MB file within 10 seconds 26092ms
     → expected 25326.794513 to be less than 10000
   × Performance Tests > File Parsing Performance > should parse 50MB file within 30 seconds 130690ms
     → expected 126390.28820699999 to be less than 30000
   × Performance Tests > File Parsing Performance > should handle memory efficiently during large file parsing 129521ms
     → expected 569904072 to be less than 209715200
   ✓ Performance Tests > Dashboard Load Performance > should load dashboard within 3 seconds 102ms
   ✓ Performance Tests > Dashboard Load Performance > should handle large datasets efficiently 200ms
   ✓ Performance Tests > Rollup Calculation Performance > should calculate rollup for 1K records within 100ms 1ms
   ✓ Performance Tests > Rollup Calculation Performance > should calculate rollup for 10K records within 500ms 7ms
   ✓ Performance Tests > Rollup Calculation Performance > should calculate rollup for 100K records within 2 seconds 42ms
   ✓ Performance Tests > Rollup Calculation Performance > should handle different rollup types efficiently 23ms
   × Performance Tests > Memory Usage > should not leak memory during file parsing 62093ms
     → expected 102773800 to be less than 52428800
   × Performance Tests > Memory Usage > should handle concurrent operations efficiently 4832ms
     → Cannot read properties of undefined (reading 'heapUsed')
   × Performance Tests > Performance Regression Tests > should maintain consistent performance across multiple runs 12119ms
     → Test timed out in 5000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".

⎯⎯⎯⎯⎯⎯ Failed Tests 27 ⎯⎯⎯⎯⎯⎯⎯

 FAIL  tests/performance/performance.test.ts > Performance Tests > File Parsing Performance > should parse 1MB file within 2 seconds
AssertionError: expected 2613.545099 to be less than 2000
 ❯ tests/performance/performance.test.ts:83:32
     81|       const { metrics } = await performanceTester.testFileParsing(file…
     82|       
     83|       expect(metrics.duration).toBeLessThan(2000);
       |                                ^
     84|       expect(metrics.rowsPerSecond).toBeGreaterThan(5000);
     85|       

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[1/27]⎯

 FAIL  tests/performance/performance.test.ts > Performance Tests > File Parsing Performance > should parse 10MB file within 10 seconds
AssertionError: expected 25326.794513 to be less than 10000
 ❯ tests/performance/performance.test.ts:95:32
     93|       const { metrics } = await performanceTester.testFileParsing(file…
     94|       
     95|       expect(metrics.duration).toBeLessThan(10000);
       |                                ^
     96|       expect(metrics.rowsPerSecond).toBeGreaterThan(10000);
     97|       

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[2/27]⎯

 FAIL  tests/performance/performance.test.ts > Performance Tests > File Parsing Performance > should parse 50MB file within 30 seconds
AssertionError: expected 126390.28820699999 to be less than 30000
 ❯ tests/performance/performance.test.ts:107:32
    105|       const { metrics } = await performanceTester.testFileParsing(file…
    106|       
    107|       expect(metrics.duration).toBeLessThan(30000);
       |                                ^
    108|       expect(metrics.rowsPerSecond).toBeGreaterThan(15000);
    109|       

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[3/27]⎯

 FAIL  tests/performance/performance.test.ts > Performance Tests > File Parsing Performance > should handle memory efficiently during large file parsing
AssertionError: expected 569904072 to be less than 209715200
 ❯ tests/performance/performance.test.ts:120:34
    118|       
    119|       // Проверяем, что использование памяти не превышает 200MB
    120|       expect(metrics.memoryPeak).toBeLessThan(200 * 1024 * 1024);
       |                                  ^
    121|       
    122|       const validation = performanceTester.validatePerformance(metrics…

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[4/27]⎯

 FAIL  tests/performance/performance.test.ts > Performance Tests > Memory Usage > should not leak memory during file parsing
AssertionError: expected 102773800 to be less than 52428800
 ❯ tests/performance/performance.test.ts:245:30
    243|       
    244|       // Память не должна увеличиться более чем на 50MB
    245|       expect(memoryIncrease).toBeLessThan(50 * 1024 * 1024);
       |                              ^
    246|     });
    247| 

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[5/27]⎯

 FAIL  tests/performance/performance.test.ts > Performance Tests > Memory Usage > should handle concurrent operations efficiently
TypeError: Cannot read properties of undefined (reading 'heapUsed')
 ❯ PerformanceTester.validatePerformance src/utils/performanceTest.ts:316:29
    314| 
    315|     // Проверка использования памяти
    316|     if (metrics.memoryUsage.heapUsed > 100 * 1024 * 1024) { // 100MB
       |                             ^
    317|       issues.push(`High memory usage: ${Math.round(metrics.memoryUsage…
    318|       passed = false;
 ❯ forEach tests/performance/performance.test.ts:267:46
 ❯ tests/performance/performance.test.ts:265:15

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[6/27]⎯

 FAIL  tests/performance/performance.test.ts > Performance Tests > Performance Regression Tests > should maintain consistent performance across multiple runs
Error: Test timed out in 5000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".
 ❯ tests/performance/performance.test.ts:274:5
    272| 
    273|   describe('Performance Regression Tests', () => {
    274|     it('should maintain consistent performance across multiple runs', …
       |     ^
    275|       const file = createMockFile(5, 50000);
    276|       const durations: number[] = [];

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[7/27]⎯

 FAIL  src/utils/__tests__/fileParser.test.ts > FileParser > parseFile > Обработка ошибок > должен проверять размер файлов
Error: Test timed out in 5000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".
 ❯ src/utils/__tests__/fileParser.test.ts:126:7
    124|       });
    125| 
    126|       it('должен проверять размер файлов', async () => {
       |       ^
    127|         // Создаем файл больше 50MB
    128|         const largeContent = new Array(60 * 1024 * 1024).fill('a').joi…

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[8/27]⎯

 FAIL  tests/unit/api/databaseAPI.test.ts > DatabaseAPI > updateDatabase > should update database properties
Unknown Error: Could not find the function public.update_database(p_id, p_updates) in the schema cache
⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[9/27]⎯

 FAIL  tests/unit/api/databaseAPI.test.ts > DatabaseAPI > deleteDatabase > should delete database and related data
Unknown Error: Could not find the function public.delete_database(p_id) in the schema cache
⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[10/27]⎯

 FAIL  tests/unit/api/databaseAPI.test.ts > DatabaseAPI > getTableSchema > should fetch table schema
Unknown Error: Could not find the function public.get_table_schemas(p_database_id) in the schema cache
⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[11/27]⎯

 FAIL  tests/unit/api/databaseAPI.test.ts > DatabaseAPI > updateTableSchema > should update table schema
TypeError: supabase.from(...).select is not a function
 ❯ Function.updateTableSchema src/api/databaseAPI.ts:207:8
    205|     const { data, error } = await supabase
    206|       .from('table_schemas')
    207|       .select('*')
       |        ^
    208|       .eq('id', id);
    209|     if (error) throw new Error(error.message);
 ❯ tests/unit/api/databaseAPI.test.ts:286:7

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[12/27]⎯

 FAIL  tests/unit/utils/formulaEngine.test.ts > FormulaEngine > parseFormula > should parse function calls
Error: Invalid syntax: Error: Unexpected token: function SUM
 ❯ parseFormula src/utils/formulaEngine.ts:816:11
    814|     return parseExpression(tokens);
    815|   } catch (error) {
    816|     throw new Error(`Invalid syntax: ${error}`);
       |           ^
    817|   }
    818| }
 ❯ tests/unit/utils/formulaEngine.test.ts:33:22

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[13/27]⎯

 FAIL  tests/unit/utils/formulaEngine.test.ts > FormulaEngine > parseFormula > should parse nested functions
Error: Invalid syntax: Error: Unexpected token: function IF
 ❯ parseFormula src/utils/formulaEngine.ts:816:11
    814|     return parseExpression(tokens);
    815|   } catch (error) {
    816|     throw new Error(`Invalid syntax: ${error}`);
       |           ^
    817|   }
    818| }
 ❯ tests/unit/utils/formulaEngine.test.ts:42:22

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[14/27]⎯

 FAIL  tests/unit/utils/formulaEngine.test.ts > FormulaEngine > parseFormula > should handle parentheses correctly
Error: Invalid syntax: RangeError: Maximum call stack size exceeded
 ❯ parseFormula src/utils/formulaEngine.ts:816:11
    814|     return parseExpression(tokens);
    815|   } catch (error) {
    816|     throw new Error(`Invalid syntax: ${error}`);
       |           ^
    817|   }
    818| }
 ❯ tests/unit/utils/formulaEngine.test.ts:64:22

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[15/27]⎯

 FAIL  tests/unit/utils/formulaEngine.test.ts > FormulaEngine > parseFormula > should throw error for invalid syntax
AssertionError: expected [Function] to throw an error

- Expected: 
null

+ Received: 
undefined

 ❯ tests/unit/utils/formulaEngine.test.ts:79:45
     77| 
     78|     it('should throw error for invalid syntax', () => {
     79|       expect(() => parseFormula('2 + + 3')).toThrow('Invalid syntax');
       |                                             ^
     80|       expect(() => parseFormula('SUM(')).toThrow('Invalid syntax');
     81|       expect(() => parseFormula('2 + )')).toThrow('Invalid syntax');

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[16/27]⎯

 FAIL  tests/unit/utils/formulaEngine.test.ts > FormulaEngine > evaluateFormula > should evaluate simple mathematical expressions
AssertionError: expected 2 to be 8 // Object.is equality

- Expected
+ Received

- 8
+ 2

 ❯ tests/unit/utils/formulaEngine.test.ts:99:50
     97|       expect(evaluateFormula('3 * 4', testData)).toBe(12);
     98|       expect(evaluateFormula('15 / 3', testData)).toBe(5);
     99|       expect(evaluateFormula('2 ^ 3', testData)).toBe(8);
       |                                                  ^
    100|     });
    101| 

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[17/27]⎯

 FAIL  tests/unit/utils/formulaEngine.test.ts > FormulaEngine > evaluateFormula > should evaluate string functions
AssertionError: expected '5' to be 5 // Object.is equality

- Expected: 
5

+ Received: 
"5"

 ❯ tests/unit/utils/formulaEngine.test.ts:120:60
    118|       expect(evaluateFormula('LOWER("WORLD")', testData)).toBe('world'…
    119|       expect(evaluateFormula('TRIM("  test  ")', testData)).toBe('test…
    120|       expect(evaluateFormula('LENGTH("hello")', testData)).toBe(5);
       |                                                            ^
    121|       expect(evaluateFormula('CONCAT("Hello", " ", "World")', testData…
    122|     });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[18/27]⎯

 FAIL  tests/unit/utils/formulaEngine.test.ts > FormulaEngine > evaluateFormula > should evaluate aggregation functions
AssertionError: expected '01,2,3,4,5' to be 15 // Object.is equality

- Expected: 
15

+ Received: 
"01,2,3,4,5"

 ❯ tests/unit/utils/formulaEngine.test.ts:143:73
    141|     it('should evaluate aggregation functions', () => {
    142|       const arrayData = [1, 2, 3, 4, 5];
    143|       expect(evaluateFormula('SUM({amounts})', { amounts: arrayData })…
       |                                                                         ^
    144|       expect(evaluateFormula('AVG({amounts})', { amounts: arrayData })…
    145|       expect(evaluateFormula('MIN({amounts})', { amounts: arrayData })…

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[19/27]⎯

 FAIL  tests/unit/utils/formulaEngine.test.ts > FormulaEngine > evaluateFormula > should handle complex nested expressions
AssertionError: expected NaN to be 66 // Object.is equality

- Expected
+ Received

- 66
+ NaN

 ❯ tests/unit/utils/formulaEngine.test.ts:155:22
    153|         { status: 'active', amounts: [10, 20, 30] }
    154|       );
    155|       expect(result).toBe(66); // (10+20+30) * 1.1 = 66
       |                      ^
    156|     });
    157| 

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[20/27]⎯

 FAIL  tests/unit/utils/formulaEngine.test.ts > FormulaEngine > evaluateFormula > should throw error for invalid expressions
AssertionError: expected [Function] to throw an error

- Expected: 
null

+ Received: 
undefined

 ❯ tests/unit/utils/formulaEngine.test.ts:160:64
    158|     it('should throw error for invalid expressions', () => {
    159|       expect(() => evaluateFormula('INVALID_FUNCTION()', testData)).to…
    160|       expect(() => evaluateFormula('{nonexistent}', testData)).toThrow…
       |                                                                ^
    161|       expect(() => evaluateFormula('1 / 0', testData)).toThrow('Divisi…
    162|     });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[21/27]⎯

 FAIL  tests/unit/utils/formulaEngine.test.ts > FormulaEngine > validateFormula > should validate correct formulas
AssertionError: expected { valid: true } to be true // Object.is equality

- Expected: 
true

+ Received: 
{
  "valid": true,
}

 ❯ tests/unit/utils/formulaEngine.test.ts:167:40
    165|   describe('validateFormula', () => {
    166|     it('should validate correct formulas', () => {
    167|       expect(validateFormula('2 + 3')).toBe(true);
       |                                        ^
    168|       expect(validateFormula('SUM({amount})')).toBe(true);
    169|       expect(validateFormula('IF({status} == "active", 1, 0)')).toBe(t…

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[22/27]⎯

 FAIL  tests/unit/utils/formulaEngine.test.ts > FormulaEngine > validateFormula > should reject invalid formulas
AssertionError: expected { valid: false, …(1) } to be false // Object.is equality

- Expected: 
false

+ Received: 
{
  "error": "Некорректная последовательность операторов: ++",
  "valid": false,
}

 ❯ tests/unit/utils/formulaEngine.test.ts:173:42
    171| 
    172|     it('should reject invalid formulas', () => {
    173|       expect(validateFormula('2 + + 3')).toBe(false);
       |                                          ^
    174|       expect(validateFormula('SUM(')).toBe(false);
    175|       expect(validateFormula('INVALID_FUNCTION()')).toBe(false);

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[23/27]⎯

 FAIL  tests/unit/utils/formulaEngine.test.ts > FormulaEngine > getAvailableFunctions > should return all available functions
AssertionError: expected [] to include 'SUM'
 ❯ tests/unit/utils/formulaEngine.test.ts:183:25
    181|       const functions = getAvailableFunctions();
    182|       
    183|       expect(functions).toContain('SUM');
       |                         ^
    184|       expect(functions).toContain('AVG');
    185|       expect(functions).toContain('IF');

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[24/27]⎯

 FAIL  tests/unit/utils/formulaEngine.test.ts > FormulaEngine > FormulaEngine class > should evaluate formula with context
AssertionError: expected 110.00000000000001 to be 110 // Object.is equality

- Expected
+ Received

- 110
+ 110.00000000000001

 ❯ tests/unit/utils/formulaEngine.test.ts:221:22
    219|       const formula = engine.createFormula('{amount} * 1.1', ['amount'…
    220|       const result = engine.evaluate(formula, { amount: 100 });
    221|       expect(result).toBe(110);
       |                      ^
    222|     });
    223| 

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[25/27]⎯

 FAIL  tests/unit/utils/formulaEngine.test.ts > FormulaEngine > FormulaEngine class > should recalculate dependent formulas
AssertionError: expected NaN to be 210 // Object.is equality

- Expected
+ Received

- 210
+ NaN

 ❯ tests/unit/utils/formulaEngine.test.ts:244:30
    242|       const results = engine.evaluateAll({ amount: 100 });
    243|       expect(results.total1).toBe(200);
    244|       expect(results.total2).toBe(210);
       |                              ^
    245|     });
    246| 

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[26/27]⎯

 FAIL  tests/unit/utils/formulaEngine.test.ts > FormulaEngine > FormulaEngine class > should handle circular dependencies
AssertionError: expected [Function] to throw an error

- Expected: 
null

+ Received: 
undefined

 ❯ tests/unit/utils/formulaEngine.test.ts:254:44
    252|       engine.addFormula('total2', formula2);
    253|       
    254|       expect(() => engine.evaluateAll({})).toThrow('Circular dependenc…
       |                                            ^
    255|     });
    256|   });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[27/27]⎯

⎯⎯⎯⎯⎯⎯ Unhandled Errors ⎯⎯⎯⎯⎯⎯

Vitest caught 1 unhandled error during the test run.
This might cause false positive tests. Resolve unhandled errors to make sure your tests are not affected.

⎯⎯⎯⎯⎯⎯ Unhandled Error ⎯⎯⎯⎯⎯⎯⎯
Error: [vitest-worker]: Timeout calling "onTaskUpdate"
 ❯ Object.onTimeoutError node_modules/vitest/dist/chunks/rpc.-pEldfrD.js:53:10
 ❯ Timeout._onTimeout node_modules/vitest/dist/chunks/index.B521nVV-.js:59:62
 ❯ listOnTimeout node:internal/timers:588:17
 ❯ processTimers node:internal/timers:523:7

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯


 Test Files  4 failed | 13 passed (17)
      Tests  27 failed | 312 passed (339)
     Errors  1 error
   Start at  20:39:23
   Duration  369.42s (transform 447ms, setup 1.50s, collect 1.25s, tests 382.98s, environment 5.45s, prepare 796ms)

